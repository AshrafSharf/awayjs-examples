(function e(t,i,a){function s(r,o){if(!i[r]){if(!t[r]){var l=typeof require=="function"&&require;if(!o&&l)return l(r,!0);if(n)return n(r,!0);var h=new Error("Cannot find module '"+r+"'");throw h.code="MODULE_NOT_FOUND",h}var d=i[r]={exports:{}};t[r][0].call(d.exports,function(e){var i=t[r][1][e];return s(i?i:e)},d,d.exports,e,t,i,a)}return i[r].exports}var n=typeof require=="function"&&require;for(var r=0;r<a.length;r++)s(a[r]);return s})({"./src/Advanced_MultiPassSponzaDemo.ts":[function(e,t,i){var a=e("awayjs-core/lib/data/SpecularImage2D");var s=e("awayjs-core/lib/data/BlendMode");var n=e("awayjs-core/lib/data/Geometry");var r=e("awayjs-core/lib/events/Event");var o=e("awayjs-core/lib/events/AssetEvent");var l=e("awayjs-core/lib/events/ProgressEvent");var h=e("awayjs-core/lib/events/LoaderEvent");var d=e("awayjs-core/lib/geom/UVTransform");var u=e("awayjs-core/lib/geom/Vector3D");var c=e("awayjs-core/lib/library/AssetLibrary");var _=e("awayjs-core/lib/library/AssetLoaderContext");var g=e("awayjs-core/lib/net/URLLoader");var f=e("awayjs-core/lib/net/URLLoaderDataFormat");var p=e("awayjs-core/lib/net/URLRequest");var m=e("awayjs-core/lib/parsers/ParserUtils");var w=e("awayjs-core/lib/ui/Keyboard");var y=e("awayjs-core/lib/utils/RequestAnimationFrame");var v=e("awayjs-display/lib/containers/Loader");var b=e("awayjs-display/lib/containers/View");var j=e("awayjs-display/lib/controllers/FirstPersonController");var M=e("awayjs-display/lib/entities/Mesh");var S=e("awayjs-display/lib/entities/Skybox");var T=e("awayjs-display/lib/entities/DirectionalLight");var x=e("awayjs-display/lib/entities/PointLight");var D=e("awayjs-display/lib/materials/lightpickers/StaticLightPicker");var A=e("awayjs-display/lib/prefabs/PrimitivePlanePrefab");var L=e("awayjs-display/lib/textures/SingleCubeTexture");var E=e("awayjs-display/lib/textures/Single2DTexture");var k=e("awayjs-renderergl/lib/tools/commands/Merge");var P=e("awayjs-renderergl/lib/DefaultRenderer");var C=e("awayjs-methodmaterials/lib/MethodMaterial");var R=e("awayjs-methodmaterials/lib/MethodMaterialMode");var O=e("awayjs-methodmaterials/lib/pool/MethodRendererPool");var U=e("awayjs-methodmaterials/lib/methods/ShadowSoftMethod");var F=e("awayjs-methodmaterials/lib/methods/EffectFogMethod");var B=e("awayjs-parsers/lib/AWDParser");var I=function(){function e(){this._assetsRoot="assets/";this._materialNameStrings=Array("arch","Material__298","bricks","ceiling","chain","column_a","column_b","column_c","fabric_g","fabric_c","fabric_f","details","fabric_d","fabric_a","fabric_e","flagpole","floor","16___Default","Material__25","roof","leaf","vase","vase_hanging","Material__57","vase_round");this._diffuseTextureStrings=Array("arch_diff.jpg","background.jpg","bricks_a_diff.jpg","ceiling_a_diff.jpg","chain_texture.png","column_a_diff.jpg","column_b_diff.jpg","column_c_diff.jpg","curtain_blue_diff.jpg","curtain_diff.jpg","curtain_green_diff.jpg","details_diff.jpg","fabric_blue_diff.jpg","fabric_diff.jpg","fabric_green_diff.jpg","flagpole_diff.jpg","floor_a_diff.jpg","gi_flag.jpg","lion.jpg","roof_diff.jpg","thorn_diff.png","vase_dif.jpg","vase_hanging.jpg","vase_plant.png","vase_round.jpg");this._normalTextureStrings=Array("arch_ddn.jpg","background_ddn.jpg","bricks_a_ddn.jpg",null,"chain_texture_ddn.jpg","column_a_ddn.jpg","column_b_ddn.jpg","column_c_ddn.jpg",null,null,null,null,null,null,null,null,null,null,"lion2_ddn.jpg",null,"thorn_ddn.jpg","vase_ddn.jpg",null,null,"vase_round_ddn.jpg");this._specularTextureStrings=Array("arch_spec.jpg",null,"bricks_a_spec.jpg","ceiling_a_spec.jpg",null,"column_a_spec.jpg","column_b_spec.jpg","column_c_spec.jpg","curtain_spec.jpg","curtain_spec.jpg","curtain_spec.jpg","details_spec.jpg","fabric_spec.jpg","fabric_spec.jpg","fabric_spec.jpg","flagpole_spec.jpg","floor_a_spec.jpg",null,null,null,"thorn_spec.jpg",null,null,"vase_plant_spec.jpg","vase_round_spec.jpg");this._numTexStrings=Array(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);this._meshReference=new Array(25);this._flameData=Array(new z(new u(-625,165,219),16755268),new z(new u(485,165,219),16755268),new z(new u(-625,165,-148),16755268),new z(new u(485,165,-148),16755268));this._textureDictionary=new Object;this._multiMaterialDictionary=new Object;this._singleMaterialDictionary=new Object;this.vaseMeshes=new Array;this.poleMeshes=new Array;this.colMeshes=new Array;this._singlePassMaterial=false;this._multiPassMaterial=true;this._cascadeLevels=3;this._shadowOptions="PCF";this._depthMapSize=2048;this._lightDirection=Math.PI/2;this._lightElevation=Math.PI/18;this._lights=new Array;this._numTextures=0;this._currentTexture=0;this._n=0;this._meshes=new Array;this._move=false;this._drag=.5;this._walkIncrement=10;this._strafeIncrement=10;this._walkSpeed=0;this._strafeSpeed=0;this._walkAcceleration=0;this._strafeAcceleration=0;this._time=0;this.init()}e.prototype.init=function(){this.initEngine();this.initLights();this.initListeners();this._n=0;this._loadingTextureStrings=this._diffuseTextureStrings;this.countNumTextures();this._n=0;this._loadingTextureStrings=this._diffuseTextureStrings;this.load(this._loadingTextureStrings[this._n])};e.prototype.initEngine=function(){this._view=new b(new P(O));this._view.camera.y=150;this._view.camera.z=0;this._cameraController=new j(this._view.camera,90,0,-80,80)};e.prototype.initLights=function(){this._lights=new Array;this._directionalLight=new T(-1,-15,1);this._directionalLight.color=15654365;this._directionalLight.ambient=.35;this._directionalLight.ambientColor=8421520;this._view.scene.addChild(this._directionalLight);this._lights.push(this._directionalLight);this.updateDirection();var e;var t=this._flameData.length;for(var i=0;i<t;i++){e=this._flameData[i];var a=e.light=new x;a.radius=200;a.fallOff=600;a.color=e.color;a.y=10;this._lights.push(a)}this._lightPicker=new D(this._lights);this._baseShadowMethod=new U(this._directionalLight,10,5);this._fogMethod=new F(0,4e3,9474279)};e.prototype.initObjects=function(){this._view.scene.addChild(new S(this._skyMap));this._flameGeometry=new A(40,80,1,1,false,true);var e;var t=this._flameData.length;for(var i=0;i<t;i++){e=this._flameData[i];var a=e.mesh=this._flameGeometry.getNewObject();a.material=this._flameMaterial;a.transform.position=e.position;a.subMeshes[0].uvTransform=new d;a.subMeshes[0].uvTransform.scaleU=1/16;this._view.scene.addChild(a);a.addChild(e.light)}};e.prototype.initListeners=function(){var e=this;window.onresize=function(t){return e.onResize(t)};document.onmousedown=function(t){return e.onMouseDown(t)};document.onmouseup=function(t){return e.onMouseUp(t)};document.onmousemove=function(t){return e.onMouseMove(t)};document.onkeydown=function(t){return e.onKeyDown(t)};document.onkeyup=function(t){return e.onKeyUp(t)};this.onResize();this.parseAWDDelegate=function(t){return e.parseAWD(t)};this.parseBitmapDelegate=function(t){return e.parseBitmap(t)};this.loadProgressDelegate=function(t){return e.loadProgress(t)};this.onBitmapCompleteDelegate=function(t){return e.onBitmapComplete(t)};this.onAssetCompleteDelegate=function(t){return e.onAssetComplete(t)};this.onResourceCompleteDelegate=function(t){return e.onResourceComplete(t)};this._timer=new y(this.onEnterFrame,this);this._timer.start()};e.prototype.updateDirection=function(){this._directionalLight.direction=new u(Math.sin(this._lightElevation)*Math.cos(this._lightDirection),-Math.cos(this._lightElevation),Math.sin(this._lightElevation)*Math.sin(this._lightDirection))};e.prototype.countNumTextures=function(){this._numTextures++;while(this._n++<this._loadingTextureStrings.length-1)if(this._loadingTextureStrings[this._n])break;if(this._n<this._loadingTextureStrings.length){this.countNumTextures()}else if(this._loadingTextureStrings==this._diffuseTextureStrings){this._n=0;this._loadingTextureStrings=this._normalTextureStrings;this.countNumTextures()}else if(this._loadingTextureStrings==this._normalTextureStrings){this._n=0;this._loadingTextureStrings=this._specularTextureStrings;this.countNumTextures()}};e.prototype.load=function(e){var t=new g;switch(e.substring(e.length-3)){case"AWD":case"awd":t.dataFormat=f.ARRAY_BUFFER;this._loadingText="Loading Model";t.addEventListener(r.COMPLETE,this.parseAWDDelegate);break;case"png":case"jpg":t.dataFormat=f.BLOB;this._currentTexture++;this._loadingText="Loading Textures";t.addEventListener(r.COMPLETE,this.parseBitmapDelegate);e="sponza/"+e;break}t.addEventListener(l.PROGRESS,this.loadProgressDelegate);var i=new p(this._assetsRoot+e);t.load(i)};e.prototype.loadProgress=function(e){var t=Math.floor(e["bytesLoaded"]/e["bytesTotal"]*100);if(t!=100){console.log(this._loadingText+"\n"+(this._loadingText=="Loading Model"?Math.floor(e["bytesLoaded"]/1024<<0)+"kb | "+Math.floor(e["bytesTotal"]/1024<<0)+"kb":this._currentTexture+" | "+this._numTextures))}};e.prototype.parseBitmap=function(e){var t=e.target;var i=m.blobToImage(t.data);i.onload=this.onBitmapCompleteDelegate;t.removeEventListener(r.COMPLETE,this.parseBitmapDelegate);t.removeEventListener(l.PROGRESS,this.loadProgressDelegate);t=null};e.prototype.onBitmapComplete=function(e){var t=e.target;t.onload=null;if(!this._textureDictionary[this._loadingTextureStrings[this._n]])this._textureDictionary[this._loadingTextureStrings[this._n]]=new E(this._loadingTextureStrings==this._specularTextureStrings?new a(m.imageToBitmapImage2D(t)):m.imageToBitmapImage2D(t));while(this._n++<this._loadingTextureStrings.length-1)if(this._loadingTextureStrings[this._n])break;if(this._n<this._loadingTextureStrings.length){this.load(this._loadingTextureStrings[this._n])}else if(this._loadingTextureStrings==this._diffuseTextureStrings){this._n=0;this._loadingTextureStrings=this._normalTextureStrings;this.load(this._loadingTextureStrings[this._n])}else if(this._loadingTextureStrings==this._normalTextureStrings){this._n=0;this._loadingTextureStrings=this._specularTextureStrings;this.load(this._loadingTextureStrings[this._n])}else{this.load("sponza/sponza.awd")}};e.prototype.parseAWD=function(e){console.log("Parsing Data");var t=e.target;var i=new v(false);i.addEventListener(o.ASSET_COMPLETE,this.onAssetCompleteDelegate);i.addEventListener(h.RESOURCE_COMPLETE,this.onResourceCompleteDelegate);i.loadData(t.data,new _(false),null,new B);t.removeEventListener(l.PROGRESS,this.loadProgressDelegate);t.removeEventListener(r.COMPLETE,this.parseAWDDelegate);t=null};e.prototype.onAssetComplete=function(e){if(e.asset.isAsset(M)){this._meshes.push(e.asset)}};e.prototype.onResourceComplete=function(e){var t=this;var i=new k(false,false,true);var a=e.target;a.removeEventListener(o.ASSET_COMPLETE,this.onAssetCompleteDelegate);a.removeEventListener(h.RESOURCE_COMPLETE,this.onResourceCompleteDelegate);var s;var r;var l=this._meshes.length;for(var d=0;d<l;d++){s=this._meshes[d];if(s.name=="sponza_04"||s.name=="sponza_379")continue;var u=Number(s.name.substring(7));r=s.material.name;if(r=="column_c"&&(u<22||u>33))continue;var g=u-125;if(r=="column_b"){if(g>=0&&g<132&&g%11<10){this.colMeshes.push(s);continue}else{this.colMeshes.push(s);var f=new k;var m=new M(new n);f.applyToMeshes(m,this.colMeshes);s=m;this.colMeshes=new Array}}var w=u-334;if(r=="vase_hanging"&&w%9<5){if(w>=0&&w<370&&w%9<4){this.vaseMeshes.push(s);continue}else{this.vaseMeshes.push(s);var y=new k;var v=new M(new n);y.applyToMeshes(v,this.vaseMeshes);s=v;this.vaseMeshes=new Array}}var b=u-290;if(r=="flagpole"){if(b>=0&&b<320&&b%3<2){this.poleMeshes.push(s);continue}else if(b>=0){this.poleMeshes.push(s);var j=new k;var S=new M(new n);j.applyToMeshes(S,this.poleMeshes);s=S;this.poleMeshes=new Array}}if(r=="flagpole"&&(u==260||u==261||u==263||u==265||u==268||u==269||u==271||u==273))continue;var T=this._materialNameStrings.indexOf(r);if(T==-1||T>=this._materialNameStrings.length)continue;this._numTexStrings[T]++;var x=this._diffuseTextureStrings[T];var D;var A;var L=this._multiMaterialDictionary[r];if(!L){L=new C(this._textureDictionary[x]);L.mode=R.MULTI_PASS;L.name=r;L.lightPicker=this._lightPicker;L.shadowMethod=this._baseShadowMethod;L.addEffectMethod(this._fogMethod);L.repeat=true;L.mipmap=true;L.specular=2;if(x.substring(x.length-3)=="png")L.alphaThreshold=.5;D=this._normalTextureStrings[T];if(D)L.normalMap=this._textureDictionary[D];A=this._specularTextureStrings[T];if(A)L.specularMap=this._textureDictionary[A];this._multiMaterialDictionary[r]=L}s.material=L;this._view.scene.addChild(s);this._meshReference[T]=s}var E=0;while(E<this._numTexStrings.length){console.log(this._diffuseTextureStrings[E],this._numTexStrings[E]);E++}c.addEventListener(h.RESOURCE_COMPLETE,function(e){return t.onExtraResourceComplete(e)});var P=new _;P.dependencyBaseUrl="assets/skybox/";c.load(new p("assets/skybox/hourglass_texture.cube"),P);c.load(new p("assets/fire.png"))};e.prototype.onExtraResourceComplete=function(e){switch(e.url){case"assets/skybox/hourglass_texture.cube":this._skyMap=new L(e.assets[0]);break;case"assets/fire.png":this._flameMaterial=new C(new E(e.assets[0]));this._flameMaterial.blendMode=s.ADD;this._flameMaterial.animateUVs=true;break}if(this._skyMap&&this._flameMaterial)this.initObjects()};e.prototype.onEnterFrame=function(e){if(this._walkSpeed||this._walkAcceleration){this._walkSpeed=(this._walkSpeed+this._walkAcceleration)*this._drag;if(Math.abs(this._walkSpeed)<.01)this._walkSpeed=0;this._cameraController.incrementWalk(this._walkSpeed)}if(this._strafeSpeed||this._strafeAcceleration){this._strafeSpeed=(this._strafeSpeed+this._strafeAcceleration)*this._drag;if(Math.abs(this._strafeSpeed)<.01)this._strafeSpeed=0;this._cameraController.incrementStrafe(this._strafeSpeed)}var t;var i=this._flameData.length;for(var a=0;a<i;a++){t=this._flameData[a];var s=t.light;if(!s)continue;s.fallOff=380+Math.random()*20;s.radius=200+Math.random()*30;s.diffuse=.9+Math.random()*.1;var n=t.mesh;if(!n)continue;var r=n.subMeshes[0];r.uvTransform.offsetU+=1/16;r.uvTransform.offsetU%=1;n.rotationY=Math.atan2(n.x-this._view.camera.x,n.z-this._view.camera.z)*180/Math.PI}this._view.render()};e.prototype.onKeyDown=function(e){switch(e.keyCode){case w.UP:case w.W:this._walkAcceleration=this._walkIncrement;break;case w.DOWN:case w.S:this._walkAcceleration=-this._walkIncrement;break;case w.LEFT:case w.A:this._strafeAcceleration=-this._strafeIncrement;break;case w.RIGHT:case w.D:this._strafeAcceleration=this._strafeIncrement;break;case w.F:break;case w.C:this._cameraController.fly=!this._cameraController.fly}};e.prototype.onKeyUp=function(e){switch(e.keyCode){case w.UP:case w.W:case w.DOWN:case w.S:this._walkAcceleration=0;break;case w.LEFT:case w.A:case w.RIGHT:case w.D:this._strafeAcceleration=0;break}};e.prototype.onMouseDown=function(e){this._lastPanAngle=this._cameraController.panAngle;this._lastTiltAngle=this._cameraController.tiltAngle;this._lastMouseX=e.clientX;this._lastMouseY=e.clientY;this._move=true};e.prototype.onMouseUp=function(e){this._move=false};e.prototype.onMouseMove=function(e){if(this._move){this._cameraController.panAngle=.3*(e.clientX-this._lastMouseX)+this._lastPanAngle;this._cameraController.tiltAngle=.3*(e.clientY-this._lastMouseY)+this._lastTiltAngle}};e.prototype.onResize=function(e){if(e===void 0){e=null}this._view.y=0;this._view.x=0;this._view.width=window.innerWidth;this._view.height=window.innerHeight};return e}();var z=function(){function e(e,t){this.position=e;this.color=t}return e}();window.onload=function(){new I}},{"awayjs-core/lib/data/BlendMode":undefined,"awayjs-core/lib/data/Geometry":undefined,"awayjs-core/lib/data/SpecularImage2D":undefined,"awayjs-core/lib/events/AssetEvent":undefined,"awayjs-core/lib/events/Event":undefined,"awayjs-core/lib/events/LoaderEvent":undefined,"awayjs-core/lib/events/ProgressEvent":undefined,"awayjs-core/lib/geom/UVTransform":undefined,"awayjs-core/lib/geom/Vector3D":undefined,"awayjs-core/lib/library/AssetLibrary":undefined,"awayjs-core/lib/library/AssetLoaderContext":undefined,"awayjs-core/lib/net/URLLoader":undefined,"awayjs-core/lib/net/URLLoaderDataFormat":undefined,"awayjs-core/lib/net/URLRequest":undefined,"awayjs-core/lib/parsers/ParserUtils":undefined,"awayjs-core/lib/ui/Keyboard":undefined,"awayjs-core/lib/utils/RequestAnimationFrame":undefined,"awayjs-display/lib/containers/Loader":undefined,"awayjs-display/lib/containers/View":undefined,"awayjs-display/lib/controllers/FirstPersonController":undefined,"awayjs-display/lib/entities/DirectionalLight":undefined,"awayjs-display/lib/entities/Mesh":undefined,"awayjs-display/lib/entities/PointLight":undefined,"awayjs-display/lib/entities/Skybox":undefined,"awayjs-display/lib/materials/lightpickers/StaticLightPicker":undefined,"awayjs-display/lib/prefabs/PrimitivePlanePrefab":undefined,"awayjs-display/lib/textures/Single2DTexture":undefined,"awayjs-display/lib/textures/SingleCubeTexture":undefined,"awayjs-methodmaterials/lib/MethodMaterial":undefined,"awayjs-methodmaterials/lib/MethodMaterialMode":undefined,"awayjs-methodmaterials/lib/methods/EffectFogMethod":undefined,"awayjs-methodmaterials/lib/methods/ShadowSoftMethod":undefined,"awayjs-methodmaterials/lib/pool/MethodRendererPool":undefined,"awayjs-parsers/lib/AWDParser":undefined,"awayjs-renderergl/lib/DefaultRenderer":undefined,"awayjs-renderergl/lib/tools/commands/Merge":undefined}]},{},["./src/Advanced_MultiPassSponzaDemo.ts"]);

//# sourceMappingURL=Advanced_MultiPassSponzaDemo.js.map